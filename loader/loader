-- loader/loader

-- VARIABLES

if not shell.dir() == "loader" then shell.setDir("loader") end


function initialsetup()
    print("Performing initial setup")
    if not fs.exists("loader/config") then

        shell.run("rm", "../setup")
        shell.run("wget", "https://tomquinn04.github.io/ccprojects/loader/initfiles")
        
        os.loadAPI("loader/initfiles")
        dl = initfiles.get()

        for i,fn in ipairs(dl) do
            shell.run("wget", fn)
        end
        os.unloadAPI("loader/initfiles")
    end

end

function runprogram()
    os.loadAPI("loader/config")
    program = config.file
    os.unloadAPI("loader/config")
    
    os.loadAPI("loader/utilities")
    os.loadAPI(program.."/def")
    shell.setDir(program)
    utilities.dllist(def.files)
    utilities.runonce(config.file.."/"..def.runonce, def.runonceargs)
end

function updateloader()
    if fs.exists("loader/loader.update") then
        shell.run("rm", "loader")
        shell.run("mv", "loader.update loader")
    else
        shell.run("wget", "https://tomquinn04.github.io/ccprojects/loader/loader loader.update")
        updateloader()
    end
end
-- MAIN

utilities = require("loader/utilities")
utilities.update()
updateloader()
runprogram()

return {initialsetup = initialsetup}