-- loader/loader

-- VARIABLES
args = {...}
if not shell.dir() == "loader" then shell.setDir("loader") end


function initialsetup()
    print("Performing initial setup")
    if not fs.exists("loader/config") then

        shell.run("rm", "../setup")
        shell.run("wget", "https://tomquinn04.github.io/ccprojects/loader/initfiles")
        
        os.loadAPI("loader/initfiles")
        dl = initfiles.get()

        for i,fn in ipairs(dl) do
            shell.run("wget", fn)
        end
        os.unloadAPI("loader/initfiles")
    end

end

function runprogram()
    config = require("config")
    local vprogram = config.getprogram()
    if not fs.exists(vprogram.."/def") then
        shell.run("wget", "https://tomquinn04.github.io/ccprojects/"..vprogram.."/def /"..vprogram.."/def")
    end
    os.loadAPI(vprogram.."/def")
    shell.setDir(vprogram)
    utilities.dellist(def.updatefiles)
    utilities.dllist(def.files)
    utilities.runonce(vprogram.."/"..def.runonce, def.runonceargs)
    shell.run(vprogram.."/"..def.startup)
end

function updateloader()
    shell.setdir("loader")
    if fs.exists("loader/loader.update") then
        shell.run("rm", "loader")
        shell.run("mv", "loader.update loader")
    else
        shell.run("wget", "https://tomquinn04.github.io/ccprojects/loader/loader loader.update")
        updateloader()
    end
end
-- MAIN

utilities = require("utilities")
if (not args[1] == "noupall" ) or (#args==0) then
    utilities.update()
    if (not args[1] == "noup") or (#args==0) then updateloader() end
end
runprogram()

return {initialsetup = initialsetup}